<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Sun</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <!-- single daterangepicker -->
    <!-- litepicker -->
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
    <!-- include polyfill first --->
    <script src="https://cdn.jsdelivr.net/npm/litepicker-polyfills-ie11/dist/index.js"></script>
    <!-- then include the Litepicker library --->
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
    <link rel="stylesheet" href="/static/css/litepicker.css">

    <!-- amchart xychart script -->
    <script src="https://cdn.amcharts.com/lib/4/core.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>

    <!-- amchart mapchart -->
    <script src="//cdn.amcharts.com/lib/4/maps.js"></script>
    <script src="//cdn.amcharts.com/lib/4/geodata/worldLow.js"></script>
    <!-- 아래의 naver 키를 넣으면 됩니다. -->
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=pky47i5x93"></script>
    <!-- 탭 누르면 데이터 콜 -->
    <script src="/static/js/tabs.js"></script>
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>


    <!-- 다혜는 테스트 중-->
    <!-- 다혜는 테스트 중-->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>

    @import url(http://fonts.googleapis.com/earlyaccess/notosanskr.css);

        * {
           font-family: 'Noto Sans KR', sans-serif;
        }

        #header {
            border-bottom: 1px solid #e8e8e8;
            position: fixed;
            width: 100%;
            height: 50px;
            text-align: center;
            background-color: white;
        }

        #footer {
            border-bottom: 1px solid #e8e8e8;
            position: fixed;
            width: 100%;
            height: 30px;
            text-align: center;
        }

        .left_title_big {
            font-size: 24px;
            color: white;
            font-weight: bold;
        }

        .left_title {
            color: #b9b9b9;
        }

        #right_size {
            margin-left: 10%;
            width: 80%;
        }


    </style>
</head>
<body>

    <div id="header">
        <img>
    </div>
    <br/><br/>
    <div id="all" style="height: 100%; width: 100%; display: flex;">
        <div id="left" style="height: 100%; width: 20%; border: 1px solid black; display: inline-block; background-color: #38393E; position: fixed;">
            <div style="width: 350px; margin-left: 30px;">
                <ul class="col" style="list-style:none;"><br/>
                    <div class="left_title_big">계산 조건</div><br/>
                    <div class="left_title">날짜</div><br/>
                    <!-- single_daterangepicker -->
                    <div>
                        <input style="width:500px;" id="litepicker" type="hidden"/>
                    </div><br/><br/><br/>
                    <!--지도 표시 구역-->
                    <div class="left_title">위치 선택</div><br/>
                     <li>
                        <select id="search" style="width: 280px;">
                            <option value="당진수상태양광" selected="true">당진 수상 태양광</option>
                            <option value="당진자재창고태양광" selected="False">당진 자재창고 태양광</option>
                            <option value="당진태양광" selected="False">당진 태양광</option>
                            <option value="울산태양광" selected="False">울산 태양광</option>
                        </select>
                    </li>
                    <li><div style="height:20px;"></div></li>
                    <li><div id="map" style="width:280px;height:300px;"></div></li>
                    <li><div id="check" style="display:none;">당진수상</div></li>
                </ul>
                <br/><br/>
            </div>
        </div>
        <div style="height: 100%; width: 20%; display: inline-block"></div>
        <div id="right" style="height: 100%; width: 80%; display: inline-block">

            <div id="right_size">
                <ul><br/><br/>
                    <div id="energy_name" style="font-size: 30px; display: inline-block"><b>당진 수산</b></div> <div style="font-size: 20px; display: inline-block">발전소의 예상치</div>
                    <br/><br/>
                </ul>
                <ul class="nav nav-tabs" style="list-style:none;" role="tablist">
                    <li class="nav-item" role="presentation">
                        <a class="nav-link active" data-toggle="tab" id="energy-sum-tab" data-bs-target="#temperature" type="button" role="tab" aria-controls="pills-temperature" aria-selected="true">하루 발전량 합계(kw)</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <ul class="tab-pane fade show active" style="list-style:none;">
                        <li id="energy-sum" role="tabpanel" aria-labelledby="pills-energy-tab">
                            <div class="chart" id="barchart" style="height: 350px;"></div>
                        </li>
                    </ul>
                </div>
                <br/><br/><br/>


                <ul class="nav nav-tabs" style="list-style:none;" role="tablist">
                    <li class="nav-item" role="presentation">
                        <a class="nav-link active" data-toggle="tab" id="energy-tab" data-bs-target="#temperature" type="button" role="tab" aria-controls="pills-temperature" aria-selected="true">태양광 에너지</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <ul class="tab-pane fade show active" style="list-style:none;">
                        <li id="energy" role="tabpanel" aria-labelledby="pills-energy-tab">
                            <div class="chart" id="xychart_2" style="height: 350px;"></div>
                        </li>
                    </ul>
                </div>
                <br/><br/><br/>

                <ul class="nav nav-tabs" style="list-style:none;" role="tablist">
                    <li class="nav-item" role="presentation">
                        <a class="nav-link active" data-toggle="tab" id="temperature-tab" data-bs-target="#temperature" type="button" role="tab" aria-controls="pills-temperature" aria-selected="true">온도</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" data-toggle="tab" id="humidity-tab" data-bs-target="#humidity" type="button" role="tab" aria-controls="pills-humidity" aria-selected="false">습도</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" data-toggle="tab" id="hr-tab" data-bs-target="#hr" type="button" role="tab" aria-controls="pills-hr" aria-selected="false">일조</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" data-toggle="tab" id="cloud-tab" data-bs-target="#cloud" type="button" role="tab" aria-controls="pills-cloud" aria-selected="false">전운량</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <ul class="tab-pane fade show active" style="list-style:none;">
                        <li id="temperature" role="tabpanel" aria-labelledby="pills-temperature-tab">
                            <div class="chart" id="xychart_1" style="height: 350px;"></div>
                        </li>
                    </ul>
                </div>
                <br/>

            </div>
        </div>

    </div>

        <!-- 임시 -->
        <input type="hidden" id="execute" value="execute">
</div>


<script src="/static/js/map.js"></script>

<script>
    $(document).ready(function() {
        var postdata = {
            'start':'2021-01-01', 'end':'2021-01-15', 'time':'2021-01-15', 'location':"당진수상 태양광", 'column':'온도'
        }
        $('#litepicker').val('2021-01-01 - 2021-01-15');
        $("#check").text('당진수상 태양광');
        $.ajax({
            type: 'POST',
            url: '{{url_for("ajax")}}',
            data: JSON.stringify(postdata),
            dataType : 'JSON',
            contentType: "application/json",
            success: function(data){
                if (data.chart_data.length == 0)
                    alert("날씨 데이터가 없습니다.");
                twoChart(data)
                barChart(data)
            },
            error: function(error) {
                console.log(error)
            }
        })
    })
    function twoChart(data) {
        var result = [];
        var energy_result = [];

        var chart_data = data.chart_data
        var energy_data = data.energy_chart_data

        for(var i in chart_data)
            chart_data[i]["date"] = new Date(chart_data[i]["date"])
        result.push(chart_data[i]);
        for(var i in energy_data)
            energy_data[i]["date"] = new Date(energy_data[i]["date"])
        energy_result.push(energy_data[i]);

        am4core.useTheme(am4themes_animated);
        // Themes end

        var chart = am4core.create("xychart_1", am4charts.XYChart);
        var energy_chart = am4core.create("xychart_2", am4charts.XYChart);

        chart.hiddenState.properties.opacity = 0; // this creates initial fade-in
        energy_chart.hiddenState.properties.opacity = 0;
        // 범례
        chart.legend = new am4charts.Legend();
        chart.legend.markers.template.disabled = true;

        energy_chart.legend = new am4charts.Legend();
        energy_chart.legend.markers.template.disabled = true;

        chart.data = chart_data;
        energy_chart.data = energy_data;

        var dateAxis = chart.xAxes.push(new am4charts.DateAxis());
        var energy_dateAxis = energy_chart.xAxes.push(new am4charts.DateAxis());

        var valueAxis = chart.yAxes.push(new am4charts.ValueAxis());
        var energy_valueAxis = energy_chart.yAxes.push(new am4charts.ValueAxis());

        valueAxis.tooltip.disabled = true;
        energy_valueAxis.tooltip.disabled = true;

        var series = chart.series.push(new am4charts.LineSeries());
        series.dataFields.dateX = "date";
        series.dataFields.openValueY = "open";
        series.dataFields.valueY = "close";
        series.tooltipText = "실제 날씨: {openValueY.value} 예측 날씨: {valueY.value}";
        series.sequencedInterpolation = true;
        series.fillOpacity = 0.3;
        series.defaultState.transitionDuration = 1000;
        series.tensionX = 0.8;
        series.name = "예측 날씨"
        series.legendSettings.labelText = "[bold {color}]{name}[/]";

        var energy_series = energy_chart.series.push(new am4charts.LineSeries());
        energy_series.dataFields.dateX = "date";
        energy_series.dataFields.openValueY = "open";
        energy_series.dataFields.valueY = "close";
        energy_series.tooltipText = "태양광 발전량: {openValueY.value} 예측 태양광 발전량: {valueY.value}";
        energy_series.sequencedInterpolation = true;
        energy_series.fillOpacity = 0.3;
        energy_series.defaultState.transitionDuration = 1000;
        energy_series.tensionX = 0.8;
        energy_series.name = "예측 태양광 발전량"
        energy_series.legendSettings.labelText = "[bold {color}]{name}[/]";

        var series2 = chart.series.push(new am4charts.LineSeries());
        series2.dataFields.dateX = "date";
        series2.dataFields.valueY = "open";
        series2.sequencedInterpolation = true;
        series2.defaultState.transitionDuration = 1500;
        series2.stroke = chart.colors.getIndex(6);
        series2.tensionX = 0.8;
        series2.name = "실제 날씨"
        series2.legendSettings.labelText = "[bold {color}]{name}[/]";

        var energy_series2 = energy_chart.series.push(new am4charts.LineSeries());
        energy_series2.dataFields.dateX = "date";
        energy_series2.dataFields.valueY = "open";
        energy_series2.sequencedInterpolation = true;
        energy_series2.defaultState.transitionDuration = 1500;
        energy_series2.stroke = chart.colors.getIndex(6);
        energy_series2.tensionX = 0.8;
        energy_series2.name = "실제 태양광 발전량"
        energy_series2.legendSettings.labelText = "[bold {color}]{name}[/]";

        chart.cursor = new am4charts.XYCursor();
        chart.cursor.xAxis = dateAxis;
        chart.scrollbarX = new am4core.Scrollbar();

        energy_chart.cursor = new am4charts.XYCursor();
        energy_chart.cursor.xAxis = energy_dateAxis;
        energy_chart.scrollbarX = new am4core.Scrollbar();
    }

    function barChart(data) {
        am4core.useTheme(am4themes_animated);
        // Themes end

        /**
         * Chart design taken from Samsung health app
         */

        var chart = am4core.create("barchart", am4charts.XYChart);
        chart.hiddenState.properties.opacity = 0; // this creates initial fade-in

        chart.data = data["barchart_data"]

        chart.dateFormatter.inputDateFormat = "YYYY-MM-dd";
        chart.zoomOutButton.disabled = true;

        var dateAxis = chart.xAxes.push(new am4charts.DateAxis());
        dateAxis.renderer.grid.template.strokeOpacity = 0;
        dateAxis.renderer.minGridDistance = 10;
        dateAxis.dateFormats.setKey("day", "d");
        dateAxis.tooltip.hiddenState.properties.opacity = 1;
        dateAxis.tooltip.hiddenState.properties.visible = true;


        dateAxis.tooltip.adapter.add("x", function (x, target) {
            return am4core.utils.spritePointToSvg({ x: chart.plotContainer.pixelX, y: 0 }, chart.plotContainer).x + chart.plotContainer.pixelWidth / 2;
        })

        var valueAxis = chart.yAxes.push(new am4charts.ValueAxis());
        valueAxis.renderer.inside = true;
        valueAxis.renderer.labels.template.fillOpacity = 0.3;
        valueAxis.renderer.grid.template.strokeOpacity = 0;
        valueAxis.min = 0;
        valueAxis.cursorTooltipEnabled = false;

        var series = chart.series.push(new am4charts.ColumnSeries);
        series.dataFields.valueY = "steps";
        series.dataFields.dateX = "date";
        series.tooltipText = "{valueY.value}";
        series.tooltip.pointerOrientation = "vertical";
        series.tooltip.hiddenState.properties.opacity = 1;
        series.tooltip.hiddenState.properties.visible = true;
        series.tooltip.adapter.add("x", function (x, target) {
            return am4core.utils.spritePointToSvg({ x: chart.plotContainer.pixelX, y: 0 }, chart.plotContainer).x + chart.plotContainer.pixelWidth / 2;
        })

        var columnTemplate = series.columns.template;
        columnTemplate.width = 30;
        columnTemplate.column.cornerRadiusTopLeft = 20;
        columnTemplate.column.cornerRadiusTopRight = 20;
        columnTemplate.strokeOpacity = 0;


        var cursor = new am4charts.XYCursor();
        cursor.behavior = "panX";
        chart.cursor = cursor;
        cursor.lineX.disabled = true;


        var middleLine = chart.plotContainer.createChild(am4core.Line);
        middleLine.strokeOpacity = 1;
        middleLine.stroke = am4core.color("#000000");
        middleLine.strokeDasharray = "2,2";
        middleLine.align = "center";
        middleLine.zIndex = 1;
        middleLine.adapter.add("y2", function (y2, target) {
            return target.parent.pixelHeight;
        })

        cursor.events.on("cursorpositionchanged", updateTooltip);
        dateAxis.events.on("datarangechanged", updateTooltip);

        function updateTooltip() {
            dateAxis.showTooltipAtPosition(0.5);
            series.showTooltipAtPosition(0.5, 0);
            series.tooltip.validate(); // otherwise will show other columns values for a second
        }


        var label = chart.plotContainer.createChild(am4core.Label);
        label.x = 90;
        label.y = 50;

    }



            // 변경시
    $('#execute, #apply').click(function(){
        var time = $('#litepicker').val();
        start = time.substr(0, 10)
        end = time.substr(13, 10)
        var location = $('#check')[0].innerHTML;
        $("#energy_name").text(location);
        var column = document.getElementsByClassName("active")[0].innerText;
        var postdata = {
            'start':start, 'end':end, 'time':time, 'location':location, 'column':column
        }
        $.ajax({
            type: 'POST',
            url: '{{url_for("ajax")}}',
            data: JSON.stringify(postdata),
            dataType : 'JSON',
            contentType: "application/json",
            success: function(data){
                if (data.chart_data.length == 0)
                    alert("날씨 데이터가 없습니다.");
                twoChart(data)
                barChart(data)
            }
        })
    });

    $('#temperature-tab, #humidity-tab, #hr-tab, #cloud-tab').click(function(){
        var time = $('#litepicker').val();
        start = time.substr(0, 10)
        end = time.substr(13, 10)
        var location = $('#check')[0].innerHTML;
        $("#energy_name").text(location);
        var column = document.getElementsByClassName("active")[0].innerText;
        var postdata = {
            'start':start, 'end':end, 'time':time, 'location':location, 'column':column
        }
        $.ajax({
            type: 'POST',
            url: '{{url_for("ajax")}}',
            data: JSON.stringify(postdata),
            dataType : 'JSON',
            contentType: "application/json",
            success: function(data){
                if (data.chart_data.length == 0)
                    alert("날씨 데이터가 없습니다.");

                var result = [];

                var chart_data = data.chart_data
                for(var i in chart_data)
                    chart_data[i]["date"] = new Date(chart_data[i]["date"])
                result.push(chart_data[i]);

                am4core.useTheme(am4themes_animated);
                // Themes end

                var chart = am4core.create("xychart_1", am4charts.XYChart);

                chart.hiddenState.properties.opacity = 0; // this creates initial fade-in
                // 범례
                chart.legend = new am4charts.Legend();
                chart.legend.markers.template.disabled = true;

                chart.data = chart_data;

                var dateAxis = chart.xAxes.push(new am4charts.DateAxis());

                var valueAxis = chart.yAxes.push(new am4charts.ValueAxis());

                valueAxis.tooltip.disabled = true;

                var series = chart.series.push(new am4charts.LineSeries());
                series.dataFields.dateX = "date";
                series.dataFields.openValueY = "open";
                series.dataFields.valueY = "close";
                series.tooltipText = "실제 날씨: {openValueY.value} 예측 날씨: {valueY.value}";
                series.sequencedInterpolation = true;
                series.fillOpacity = 0.3;
                series.defaultState.transitionDuration = 1000;
                series.tensionX = 0.8;
                series.name = "예측 날씨"
                series.legendSettings.labelText = "[bold {color}]{name}[/]";

                var series2 = chart.series.push(new am4charts.LineSeries());
                series2.dataFields.dateX = "date";
                series2.dataFields.valueY = "open";
                series2.sequencedInterpolation = true;
                series2.defaultState.transitionDuration = 1500;
                series2.stroke = chart.colors.getIndex(6);
                series2.tensionX = 0.8;
                series2.name = "실제 날씨"
                series2.legendSettings.labelText = "[bold {color}]{name}[/]";

                chart.cursor = new am4charts.XYCursor();
                chart.cursor.xAxis = dateAxis;
                chart.scrollbarX = new am4core.Scrollbar();
            }
        })
    });

    $(document).ready(function() {
        $("#search").select2();
    });


    $("#search").change(function(){
        var loc = $(this).val();
        console.log(loc)
        $("#check").text(loc)
        $("#execute").trigger("click")
    });

</script>

<script src="/static/js/litepicker.js"></script>
</body>
</html>